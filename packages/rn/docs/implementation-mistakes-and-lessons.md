# 実装で犯した主な誤りと今後の対策（改訂2）

本プロジェクトの実装過程で発生した主な誤り・反省点と、それを踏まえた具体的な対策をまとめます。  
今後同じミスを繰り返さないための「開発者向けチェックリスト」として活用してください。

---

## 1. インターフェース契約違反

- **誤り**:
  - @aokiapp/jsapdu-interfaceの抽象クラス（SmartCardPlatform/Device/Card）を継承せず、独自型やNitro ModulesのHybridObjectのみで進めてしまった。
- **対策**:
  - 仕様・契約・型定義を最初に精読し、必ず最上位インターフェースから継承して設計・実装を始める。
  - コードレビュー時も「継承漏れ」「型不一致」を重点チェック。

---

## 2. 設計パターンの不適切な選択

- **誤り**:
  - NitroModuleインスタンスを各クラスで持ち回る設計を採用し、依存性が分散・責務分離が崩れた。
- **対策**:
  - 依存性注入・Factory/Singletonパターンなど、依存性管理を徹底する。
  - 依存性の集約ポイントを明確にし、テスト容易性・保守性を高める。

---

## 3. 型・APIの不整合

- **誤り**:
  - CommandApdu/ResponseApdu型を使わず、ArrayBufferや独自型でAPDU処理をしていた。
- **対策**:
  - 型・APIの一貫性を保ち、型エラーやAPI不一致はCI/ビルドで即検知・修正する。
  - 公式型・契約を常に参照し、独自拡張は最小限に。

---

## 4. タスク分割・TODO管理の甘さ

- **誤り**:
  - 初期のTODOリストが粗く、細かい作業や中断時の積み残し、設計変更の反映が遅れた。
- **対策**:
  - ユーザー指摘や新たな課題を即時TODOに反映し、進行中の作業とTODOの同期を取る。
  - 作業単位を細かく分割し、進捗・中断・再開が容易なタスク管理を徹底。

---

## 5. ドキュメント・仕様の読み飛ばし

- **誤り**:
  - ドキュメント（implementer-checklists.mdやmy-requests.md）に明記された「絶対に守るべき規約」や「設計原則」を十分に精読せず、部分的な理解で実装を進めた。
- **対策**:
  - 仕様・設計ドキュメントを最初に徹底的に精読し、TODO・設計・実装・テストに一貫して反映する。
  - 「単一情報源」「重複排除」方針を徹底し、情報の分散・矛盾を防ぐ。

---

## 6. 大規模修正・マルチタスクのリスクと活用

- **現実**:
  - 一括大量修正や大規模リファクタリングは、**頭が良く全体を俯瞰できる人間・チームならば、むしろ時間短縮・効率化に繋がる**。
  - ただし、設計・仕様・型・API・テスト・受入基準を全て把握し、全体の整合性を保てることが前提。
  - **頭が悪い・経験が浅い場合は、むしろ小さな単位での修正・検証を徹底した方が安全**。
- **対策**:
  - 大規模修正・マルチタスクを行う場合は、必ず「全体設計・仕様・型・API・テスト・受入基準」を事前に整理し、TODOや設計資料に明示する。
  - 修正後は段階的にビルド・テスト・型検証を挟み、エラーや設計ミスを早期に発見・修正する。
  - チーム・個人のスキルに応じて「一括修正」か「小分け修正」かを選択する。

---

## 7. Kotlin/TypeScript両対応の設計検証不足

- **誤り**:
  - TypeScript側で型が通ってもKotlin側でビルドが通らない、またはその逆のケースを見逃した。
- **対策**:
  - 両言語の型・API・ビルドを常にCI/自動テストで検証し、どちらか一方だけで進めない。

---

## 8. ユーザー体験・開発者体験の軽視

- **誤り**:
  - 実装例やテスト例、デバッグガイドの活用が不十分で、開発者・利用者目線の検証が弱かった。
- **対策**:
  - サンプル・テスト・デバッグガイドを積極的に活用し、実際の利用シナリオで動作検証を行う。

---

## 9. エラー・例外処理の一貫性不足

- **誤り**:
  - AndroidErrorMapperやSmartCardErrorの正規化を徹底せず、例外のラップやエラーコードの一貫性が崩れた箇所があった。
- **対策**:
  - エラー・例外処理の一貫性をCI/自動テストで常に担保し、例外のラップ・エラーコードの正規化を徹底する。

---

## 10. ユーザー指摘・レビューの反映遅れ

- **誤り**:
  - 指摘を受けてから設計全体の見直しやTODOの修正が遅れ、同じミスを繰り返すリスクが高まった。
- **対策**:
  - ユーザー指摘や新たな課題は即時TODO・設計・実装に反映し、進行中の作業と同期を取る。

---

# 開発者向けチェックリスト（抜粋）

- [ ] 仕様・契約・型定義を最初に精読し、必ず継承・型準拠から設計を始める
- [ ] 依存性はFactory/Singletonで集約し、持ち回りを避ける
- [ ] 型・API・エラー処理の一貫性をCI/自動テストで担保する
- [ ] TODOリストは細かく・即時反映・進捗と同期
- [ ] ドキュメント・設計・実装・テストを一貫して管理
- [ ] 大規模修正・マルチタスクは全体設計・型・API・テストを把握できる場合のみ活用
- [ ] 両言語（Kotlin/TypeScript）で常に型・ビルド検証
- [ ] サンプル・テスト・デバッグガイドを積極活用
- [ ] ユーザー指摘・レビューは即時TODO・設計に反映

---

**この反省と対策を今後の開発・レビュー・タスク管理に必ず活かしてください。**
