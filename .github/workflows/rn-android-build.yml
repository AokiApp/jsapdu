name: RN Android Build

on:
  push:
    branches: [main]
    paths:
      - "packages/rn/**"
      - "examples/rn/**"
      - ".github/workflows/rn-android-build.yml"
      - "docs/android-build.md"
  pull_request:
    paths:
      - "packages/rn/**"
      - "examples/rn/**"
      - ".github/workflows/rn-android-build.yml"
      - "docs/android-build.md"
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  android:
    runs-on: ubuntu-latest
    env:
      REACT_NATIVE_ARCHITECTURES: arm64-v8a
      GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m -XX:MaxMetaspaceSize=1024m"
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: 22
          cache: "npm"
          registry-url: "https://npm.pkg.github.com"
          scope: "@aokiapp"
          always-auth: true

      - name: Setup Java 21
        uses: actions/setup-java@v5.1.0
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.2
        with:
          packages: platforms;android-35 build-tools;35.0.0 ndk;27.0.12077973 cmake;3.22.1

      - name: Install dependencies
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build packages (generates nitrogen files)
        run: npm run build

      - name: Build RN library and app (Release)
        working-directory: examples/rn/android
        run: |
          ./gradlew --info --no-parallel --max-workers=2 -PreactNativeArchitectures=${REACT_NATIVE_ARCHITECTURES} :react-native-nitro-modules:assembleRelease :aokiapp_jsapdu-rn:assembleRelease :app:assembleRelease

      - name: Upload library AARs
        uses: actions/upload-artifact@v5.0.0
        with:
          name: android-library-aar
          path: packages/rn/android/build/outputs/aar/aokiapp_jsapdu-rn-release.aar
          if-no-files-found: warn

      - name: Upload example app APK
        uses: actions/upload-artifact@v5.0.0
        with:
          name: example-app-apk
          path: examples/rn/android/app/build/outputs/apk/release/app-release.apk
          if-no-files-found: warn

  library-checks:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m"
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: 22
          cache: "npm"
          registry-url: "https://npm.pkg.github.com"
          scope: "@aokiapp"
          always-auth: true

      - name: Setup Java 21
        uses: actions/setup-java@v5.1.0
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.2
        with:
          packages: platforms;android-35 build-tools;35.0.0

      - name: Install dependencies
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build packages (generates nitrogen files)
        run: npm run build

      - name: Run Spotless/Lint read-only checks on library
        working-directory: examples/rn/android
        run: |
          ./gradlew --no-daemon --info :aokiapp_jsapdu-rn:spotlessCheck :aokiapp_jsapdu-rn:lint

      - name: Upload Lint report (if present)
        uses: actions/upload-artifact@v5.0.0
        with:
          name: android-lint-report
          path: packages/rn/android/build/reports/lint-results*.html
          if-no-files-found: warn
