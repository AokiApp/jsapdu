# スマートカードMCPサーバ要件定義書

**文書番号:** SCMCP-REQ-001  
**版数:** 2.0  
**作成日:** 2025年7月16日  
**作成者:** 開発チーム  
**承認者:** [承認者名]  

---

## 1. 文書概要

### 1.1 目的
本文書は、スマートカードModel Context Protocol（MCP）サーバシステムの要件を定義するものである。本システムは、AI エージェントがスマートカードハードウェアと標準化されたインターフェースを通じて相互作用するための基盤を提供する。

### 1.2 適用範囲
本要件定義は、ISO 7816準拠のスマートカード全般を対象とし、特定のカード種別に依存しない汎用的なMCPサーバの構築を対象とする。

### 1.3 前提条件
- PC/SCミドルウェアが正常に動作していること
- Node.js 18以上の実行環境が利用可能であること
- FastMCPフレームワークを使用すること
- @aokiappパッケージ群が利用可能であること

---

## 2. システム概要

### 2.1 システム構成
```
AI エージェント (Claude, GPT等)
          ↓
    MCP プロトコル
          ↓
スマートカードMCPサーバ (FastMCP基盤)
          ↓
    @aokiapp/pcsc
          ↓
    PC/SCミドルウェア
          ↓
  スマートカードハードウェア
```

### 2.2 基本方針
- **カード非依存性**: 特定のカード種別の知識を持たない汎用設計
- **ステートレス操作**: 各ツール操作は独立性を保つ
- **リソース安全性**: 適切なクリーンアップとリソース管理
- **マルチリーダ対応**: 複数のカードリーダの同時処理
- **エラー透過性**: 明確なエラー報告と状態解釈

---

## 3. 機能要件

### 3.1 提供機能一覧

| 機能ID | 機能名 | 概要 | 優先度 |
|--------|--------|------|--------|
| F001 | リーダ一覧取得 | 利用可能なスマートカードリーダを列挙する | 必須 |
| F002 | カード接続 | 指定されたリーダのスマートカードとの通信セッションを確立する | 必須 |
| F003 | カード切断 | スマートカードとの通信セッションを終了する | 必須 |
| F004 | APDU送信 | スマートカードにAPDUコマンドを送信し応答を受信する | 必須 |
| F005 | カードリセット | スマートカードのハードウェアリセットを実行する | 必須 |
| F006 | ステータスコード解釈 | APDU応答のステータスコードを人間可読形式で解釈する | 必須 |
| F007 | 強制リーダ解放 | 利用不能状態のリーダを強制的に解放する | 推奨 |

### 3.2 機能詳細仕様

#### 3.2.1 F001: リーダ一覧取得 (listReaders)

**入力パラメータ:**
- なし

**出力形式:**
```typescript
{
  success: boolean,
  readers: Array<{
    id: string,
    name: string,
    isAvailable: boolean,
    hasCard: boolean,
    description?: string,
    isIntegrated?: boolean,
    isRemovable?: boolean,
    supportsApdu?: boolean,
    supportsHce?: boolean
  }>,
  count: number,
  timestamp: string
}
```

**処理概要:**
1. PC/SCプラットフォームの初期化確認
2. システム内の利用可能なPC/SCリーダの検索
3. 各リーダの利用可能性確認
4. 各リーダでのカード存在検出
5. 包括的なリーダ一覧の返却

#### 3.2.2 F002: カード接続 (connectToCard)

**入力パラメータ:**
```typescript
{
  useDefaultReader: boolean = true,
  readerId?: string
}
```

**出力形式:**
```typescript
{
  success: boolean,
  atr: string,
  protocol: "T=0" | "T=1" | "T=CL",
  reader: ReaderInfo
}
```

**処理概要:**
1. リーダIDの妥当性確認と利用可能性検証
2. 指定リーダでのカード存在確認
3. カードへの排他的または共有アクセス取得
4. カードリセット実行とATR取得
5. 通信プロトコル確立 (T=0, T=1等)
6. FastMCPのセッション（context.session）にカード接続情報を保存

#### 3.2.3 F003: カード切断 (disconnectFromCard)

**入力パラメータ:**
```typescript
{
  // パラメータなし（MCPクライアントごとのセッションで管理されるため不要）
}
```

**出力形式:**
```typescript
{
  success: boolean,
  message: string,
  reader?: ReaderInfo
}
```

**処理概要:**
1. FastMCPのセッション（context.session）からカード接続情報を取得
2. 実行中トランザクションの終了
3. カード接続の適切な解放
4. 割り当てリソースの解放
5. FastMCPのセッション状態を自動的にクリーンアップ

#### 3.2.4 F004: APDU送信 (transmitApdu)

**入力パラメータ (選択肢1: 16進文字列):**
```typescript
{
  type: "hex",
  command: string
}
```

**入力パラメータ (選択肢2: 構造化):**
```typescript
{
  type: "structured",
  cla: number,
  ins: number,
  p1: number,
  p2: number,
  data?: string,
  le?: number
}
```

**出力形式:**
```typescript
{
  success: boolean,
  data: string,
  sw: string,
  timing: number
}
```

**処理概要:**
1. 入力パラメータと形式の妥当性確認
2. 適切なAPDUコマンド構造の構築
3. 標準およびExtended APDUフォーマットの処理
4. 接続されたカードへのコマンド送信
5. 応答データとステータスの受信・解析
6. 性能分析のための実行時間測定

#### 3.2.5 F005: カードリセット (resetCard)

**入力パラメータ:**
```typescript
{}
```

**出力形式:**
```typescript
{
  success: boolean,
  atr: string,
  protocol: "T=0" | "T=1" | "T=CL"
}
```

**処理概要:**
1. FastMCPのセッション（context.session）からカード接続情報を取得
2. カードへのPC/SCリセットコマンド送信
3. カードのリセットサイクル完了待機
4. 新しいAnswer To Reset (ATR)の取得
5. 通信プロトコルの再確立
6. FastMCPのセッション状態を更新

#### 3.2.6 F006: ステータスコード解釈 (lookupStatusCode)

**入力パラメータ:**
```typescript
{
  sw: string
}
```

**出力形式:**
```typescript
{
  sw: string,
  category: "success" | "warning" | "error",
  meaning: string,
  action: string
}
```

**処理概要:**
1. 4桁16進ステータスコードの標準フォーマット化
2. ISO 7816-4リファレンスでのステータスコード検索
3. 成功、警告、エラーとしてのカテゴライズ
4. 詳細な人間可読説明の提供
5. 適切な次回アクションの提案

#### 3.2.7 F007: 強制リーダ解放 (forceReleaseReader)

**入力パラメータ:**
```typescript
{
  readerId: string
}
```

**出力形式:**
```typescript
{
  success: boolean,
  message: string,
  readerId: string
}
```

**処理概要:**
1. 対象リーダの現在のロック状態確認
2. PC/SCレベルでのデバイス/カード解放試行
3. 操作結果の取得
4. 全操作のログ記録

---

## 4. 非機能要件

### 4.1 パフォーマンス要件

| 項目 | 要件値 |
|------|--------|
| APDU送信応答時間 | 標準コマンド: < 100ms |
| リーダ一覧取得時間 | < 500ms |
| 接続確立時間 | < 1000ms |
| リソースクリーンアップ時間 | < 200ms |

### 4.2 信頼性要件
- クライアント切断時の自動リソースクリーンアップ
- カード抜去時の適切な処理
- 堅牢なエラー回復メカニズム
- セッション状態の一貫性

### 4.3 互換性要件
- Windows、macOS、LinuxのPC/SC実装対応
- ISO 7816-4準拠スマートカード対応
- USB、Bluetooth、NFCカードリーダ対応
- stdioおよびHTTP転送モード対応

### 4.4 セキュリティ要件
- 機密データの永続的な保存禁止
- 安全なリソースクリーンアップ
- デフォルトでの読み取り専用操作
- 最小権限要件

---

## 5. システム制約

### 5.1 技術制約
- Node.js 18+実行環境
- システムにインストールされたPC/SCミドルウェア
- FastMCPフレームワークのMCPプロトコル対応
- @aokiappパッケージ群による基盤機能提供

### 5.2 運用制約
- PC/SCサービスの実行必須
- カードリーダ用適切なドライバ
- ハードウェアアクセス用システム権限
- アプリケーション毎の単一PC/SCコンテキスト

---

## 6. インターフェース仕様

### 6.1 外部インターフェース
- **MCPプロトコル**: AI エージェントとの標準通信
- **PC/SC API**: OS標準スマートカードインターフェース
- **HTTP/WebSocket**: リモートクライアント対応 (オプション)

### 6.2 内部インターフェース
- **FastMCPフレームワーク**: ツール、リソース、プロンプト管理
- **@aokiapp/interface**: 抽象化レイヤー
- **@aokiapp/pcsc**: PC/SC具象実装

---

## 7. エラー処理要件

### 7.1 エラーカテゴリ
- **NOT_INITIALIZED**: プラットフォーム未初期化
- **NO_READERS**: リーダ未検出
- **READER_ERROR**: リーダハードウェアエラー
- **NOT_CONNECTED**: アクティブセッション無し
- **CARD_NOT_PRESENT**: カード未挿入
- **TRANSMISSION_ERROR**: 通信障害
- **PROTOCOL_ERROR**: プロトコルネゴシエーション失敗

### 7.2 エラー処理方針
- 全エラーのUserErrorへのマッピング
- ユーザフレンドリーなエラーメッセージ
- 具体的な回復アクション提案
- 適切なログ記録

---

## 8. ログ要件

### 8.1 ログレベル
- **ERROR**: 操作失敗
- **INFO**: 重要な操作 (接続、切断等)
- **DEBUG**: 詳細トラブルシューティング情報

### 8.2 ログ内容
- クライアント接続/切断イベント
- ツール呼び出し成功/失敗
- 強制解放操作 (誰が/いつ/どのリーダ)
- 重要なエラー条件

---

## 9. テスト要件

### 9.1 単体テスト
- 各ツール機能の独立テスト
- エラー条件の網羅的テスト
- Zodスキーマ検証テスト

### 9.2 統合テスト
- 実際のスマートカードを使用したE2Eテスト
- 複数リーダでの同時操作テスト
- クライアント切断時のクリーンアップテスト

### 9.3 性能テスト
- 応答時間要件の検証
- 同時接続時の性能測定
- メモリリーク検証

---

## 10. 運用要件

### 10.1 監視要件
- ヘルスチェックエンドポイント提供
- PC/SCサービス状態監視
- リーダ利用可能性監視

### 10.2 保守要件
- ログローテーション対応
- 引数ベース設定による柔軟な運用
- バージョンアップ時の後方互換性

---

## 11. 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトマネージャー | [PM名] | 2025/07/16 | |
| システムアーキテクト | [SA名] | 2025/07/16 | |
| 品質保証責任者 | [QA名] | 2025/07/16 | |

---

**文書終了**